name: "Terraform Security Scan"
description: "terraform scurity scan"
inputs:
  github_token:
    description: GitHub token to use
    required: true
  tf_working_dir:
    description: Path to directory where terraform commands should be run
    required: false
    default: "./"
runs:
  using: "composite"
  steps:
    - name: Set up Terraform cli
      uses: hashicorp/setup-terraform@v3
    - name: TF init
      shell: bash
      working-directory: ${{ inputs.tf_working_dir }}
      run: terraform init -input=false -backend=false

    - name: Security scan - Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@0.33.1
      with:
        scan-type: "fs"
        format: "sarif"
        output: "trivy-results.sarif"
        scanners: "vuln,secret,misconfig,license"

    - name: Upload Trivy scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v4
      with:
        sarif_file: 'trivy-results.sarif'
